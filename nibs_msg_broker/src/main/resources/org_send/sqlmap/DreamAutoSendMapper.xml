<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.nicetcm.nibsplus.dreamautosend.dao.DreamAutoSendMapper">

	<select id="ACPT_CUST_0DM" parameterType="com.nicetcm.nibsplus.dreamautosend.model.DreamAutoSendVO">
		select 	mng.org_cd,
				CASE WHEN mng.org_cd = '031'
					 THEN '0'||mng.branch_cd
				     ELSE mng.branch_cd
				END as branch_cd,
				mng.site_cd,		
				MNG.mac_no,
				mng.create_date,
				mng.error_no
		from    op.t_ct_error_mng mng,
		        op.T_CT_ERROR  ERR,
		        op.t_cm_site_01    site
		where    nvl(mng.close_yn, '0') = '0'
		AND        mng.ARRIVAL_TIME IS NULL
		AND        NVL(mng.ERROR_STATUS, '0' ) <> '7000'
		AND        ( mng.ORG_CUST_RECV_YN = 'Y' OR ERR.ALARM_MON_YN = 'Y')
		AND     mng.CREATE_DATE > TO_CHAR( SYSDATE-1, 'YYYYMMDD' )
		and      nvl(site.alarm, '0') = '1' 
		and        mng.org_cd = site.org_cd
		and     mng.branch_cd = site.branch_cd
		and        mng.site_cd = site.site_cd
		AND     MNG.ORG_CD = ERR.ORG_CD(+)
		AND     MNG.ERROR_CD = ERR.ERROR_CD(+)
	</select>
	
	<select id="ARR_EST_0DM" parameterType="com.nicetcm.nibsplus.dreamautosend.model.DreamAutoSendVO">
		select 	mng.org_cd,
				CASE WHEN mng.org_cd = '031'
					 THEN '0'||mng.branch_cd
				     ELSE mng.branch_cd
				END as branch_cd,
				mng.site_cd,		
				mng.mac_no,
				mng.create_date,
				mng.error_no,
				mng.recv_user_uid,
				mng.arrival_est_date,
				mng.arrival_est_time,
				DECODE( mng.close_yn, '1', '0', <!-- /* 고객대기접수완료 			'1' -> '3'	*/ -->
									  '2', '0', <!-- /* 고객대기접수완료 후 예정입력 '2' -> '3'	*/ -->
									  'A', 'P', <!-- /* PDA 재입력 10분이내 			'A' -> '3'	*/ -->
									  'C', 'P', <!-- /* PDA 재입력 10분초과 			'C' -> 'D'	*/ --> 
									  'B', 'A', <!-- /* 관제 재입력 15분이하 		'B' -> '3'	*/ -->
									  'X', 'A', <!-- /* 관제 재입력 15분초과 		'X' -> 'Y'	*/ -->
									       '0' ) AS EST_FLAG,
				mng.CLOSE_YN
		from    op.t_ct_error_mng    mng,
		        op.T_CT_ERROR          ERR,
		        op.t_cm_site_01        site
		where    mng.arrival_est_time is not null
		and        nvl(mng.close_yn, '0') IN ( '1', '2', 'A', 'B', 'X', 'C' )
		AND        mng.ARRIVAL_TIME IS NULL
		AND        NVL(mng.ERROR_STATUS, '0' ) <> '7000'
		AND        mng.FINISH_TIME IS NULL
		AND     mng.CREATE_DATE > TO_NUMBER(TO_CHAR( SYSDATE-1, 'YYYYMMDD' ))
		AND        ( mng.ORG_CUST_RECV_YN = 'Y' OR ERR.ALARM_MON_YN = 'Y' )
		and      nvl(site.alarm, '0') = '1' 
		and        mng.org_cd = site.org_cd
		and     mng.branch_cd = site.branch_cd
		and        mng.site_cd = site.site_cd
		AND     MNG.ORG_CD = ERR.ORG_CD(+)
		AND     MNG.ERROR_CD = ERR.ERROR_CD(+)
	</select>
	
	<select id="ARRIVAL_0DM" parameterType="com.nicetcm.nibsplus.dreamautosend.model.DreamAutoSendVO">
		select 	mng.org_cd,
				CASE WHEN mng.org_cd = '031'
					 THEN '0'||mng.branch_cd
				     ELSE mng.branch_cd
				END as branch_cd,
				mng.site_cd,		
				mng.mac_no,
				mng.create_date,
				mng.error_no,
				mng.recv_user_uid,
				mng.arrival_date,
				mng.arrival_time
		from	op.t_ct_error_mng mng,
				op.t_cm_site_01		site
		where	mng.close_yn in ( '1', '2', '3', 'A', 'B', 'C', 'D', 'X', 'Y' )
		AND		mng.ARRIVAL_TIME IS NOT NULL
		AND mng.CREATE_DATE > TO_NUMBER(TO_CHAR( SYSDATE-3, 'YYYYMMDD' ))
		and      nvl(site.alarm, '0') = '1' 
		and		mng.org_cd = site.org_cd
		and 	mng.branch_cd = site.branch_cd
		and		mng.site_cd = site.site_cd
	</select>
	
	<select id="CALL_CANL_0DM">
		select 	mng.org_cd,
				CASE WHEN mng.org_cd = '031'
					 THEN '0'||mng.branch_cd
				     ELSE mng.branch_cd
				END as branch_cd,
				mng.site_cd,		
				mng.mac_no,
				mng.create_date,
				mng.error_no,
				mng.finish_date,
				substr(mng.finish_time, 1, 4)
		from    op.t_ct_error_mng mng,
		        op.T_CT_ERROR      ERR,
		        op.t_cm_site_01        site
		where    mng.close_yn in ( '1', '2', '3', 'A', 'B', 'C', 'D', 'X', 'Y' )
		AND        mng.ARRIVAL_TIME IS NULL
		AND        NVL(mng.ERROR_STATUS, '0' ) = '7000'
		AND        (mng.ORG_CUST_RECV_YN = 'Y' OR ERR.ALARM_MON_YN = 'Y' )
		AND     mng.CREATE_DATE > TO_CHAR( SYSDATE-1, 'YYYYMMDD' )
		and     nvl(site.alarm, '0') = '1' 
		and        mng.org_cd = site.org_cd
		and     mng.branch_cd = site.branch_cd
		and        mng.site_cd = site.site_cd
		AND     MNG.ORG_CD = ERR.ORG_CD(+)
		AND     MNG.ERROR_CD = ERR.ERROR_CD(+)
	</select>
	
	<update id="">
		update	op.T_CT_ERROR_MNG
		set		CLOSE_YN = #{szFlag},
				UPDATE_UID = 'Dream',
				UPDATE_DATE = SYSDATE
		where	CREATE_DATE = #{szCreateDate}
		AND		ERROR_NO = #{szErrorNo}
	</update>
	
</mapper>